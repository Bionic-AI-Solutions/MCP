events {
    worker_connections 1024;
}

http {
    # Enable dynamic DNS resolution for Docker container names
    # This allows nginx to resolve container names even if they're not running at startup
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 5s;
    
    # Map to provide default session ID for calculator initialization
map $http_mcp_session_id $mcp_session_id {
    "" "init-$request_id";
    default $http_mcp_session_id;
}

# Map to determine if POST to /sse should go to /mcp
map "$request_method:$uri" $sse_post_rewrite {
    "POST:/minio/sse" "/mcp";
    default "";
}
    
    # Upstream definitions for MCP servers
    # Add new upstream blocks here for new MCP servers
    # Using variables with resolver for dynamic DNS resolution
    upstream mcp_calculator_backend {
        server mcp-calculator-server:8000;
    }

    upstream mcp_minio_backend {
        server mcp-minio-server-new:8002;
        # Force HTTP/1.1 to avoid HTTP/2 mismatch (421 errors)
        keepalive 32;
    }

    upstream mcp_minio_backend_new {
        server mcp-minio-server-new:8002;
        keepalive 32;
    }

    upstream mcp_database_backend {
        server mcp-database-server:8000;
    }

    upstream mcp_postgres_backend {
        server mcp-postgres-server-new:8001;
        # Force HTTP/1.1 to avoid HTTP/2 mismatch (421 errors)
        keepalive 32;
    }

    upstream mcp_postgres_backend_new {
        server mcp-postgres-server-new:8001;
        keepalive 32;
    }

    upstream mcp_pdf_generator_backend {
        server mcp-pdf-generator-server:8003;
        keepalive 32;
    }

    # Archon upstream (for archon.baisoln.com)
    upstream archon_backend {
        server archon-mcp:8051;
    }

    # Archon UI upstream
    upstream archon_ui_backend {
        server archon-ui:3737;
    }

    # HTTP server for Let's Encrypt challenge
    server {
        listen 80;
        server_name mcp.bionicaisolutions.com archon.baisoln.com;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS server for mcp.bionicaisolutions.com
    server {
        listen 443 ssl;
        http2 on;
        server_name mcp.bionicaisolutions.com;
        
        # Disable HTTP/2 server push to avoid 421 errors
        http2_push_preload off;
        # Allow HTTP/2 to HTTP/1.1 downgrade for backend connections
        http2_max_field_size 16k;
        http2_max_header_size 32k;

        ssl_certificate /etc/letsencrypt/live/mcp.bionicaisolutions.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/mcp.bionicaisolutions.com/privkey.pem;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Common SSE proxy settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;

        # Calculator MCP Server
        # Route: mcp.bionicaisolutions.com/calculator/mcp
        location = /calculator/mcp {
            proxy_pass http://mcp_calculator_backend/mcp;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
        }

        # Route: mcp.bionicaisolutions.com/calculator/sse
        # Handle POST to /calculator/ (for Cursor discovery) - rewrite to /mcp
        # Add default session ID for initialization requests if not provided
        location = /calculator/ {
            # Use mapped session ID (defaults to init-$request_id if not provided)
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            
            if ($request_method = POST) {
                rewrite ^ /mcp break;
                proxy_pass http://mcp_calculator_backend;
                break;
            }
            # For GET, redirect to SSE endpoint
            return 301 /calculator/sse;
        }
        
        # Handle /calculator/message requests (with session ID from SSE)
        location ~ ^/calculator/message {
            rewrite ^/calculator/(.*) /$1 break;
            proxy_pass http://mcp_calculator_backend;
        }
        
        # Handle all other /calculator/* paths
        location /calculator/ {
            rewrite ^/calculator/(.*) /$1 break;
            proxy_pass http://mcp_calculator_backend;
        }
        
        # Handle /message requests (without /calculator/ prefix - from SSE response)
        # Route to calculator backend since that's the only one using /message endpoint
        # This must come before the default location block
        location /message {
            proxy_pass http://mcp_calculator_backend;
        }

        # Minio MCP Server
        # Route: mcp.bionicaisolutions.com/minio/mcp
        location = /minio/mcp {
            proxy_pass http://mcp_minio_backend_new/mcp;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
            # Pass MinIO tenant headers for multi-tenant mode
            proxy_set_header X-Minio-Tenant-Id $http_x_minio_tenant_id;
        }

        # Route: mcp.bionicaisolutions.com/minio/sse
        # Handle POST to /minio/ (for Cursor discovery) - rewrite to /mcp like calculator
        location = /minio/ {
            # Use mapped session ID (defaults to init-$request_id if not provided)  
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header Accept "application/json, text/event-stream";
            
            if ($request_method = POST) {
                # For POST, rewrite to /mcp endpoint (like calculator)
                rewrite ^ /mcp break;
                proxy_pass http://mcp_minio_backend_new;
                break;
            }
            # For GET, redirect to SSE endpoint
            return 301 /minio/sse;
        }
        
        # Handle POST to /minio/sse (Cursor tries this for streamableHttp) - rewrite to /mcp
        location = /minio/sse {
            # Common proxy settings
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_buffering off;
            proxy_cache off;
            
            # For POST, rewrite to /mcp; for GET, rewrite to /sse
            if ($request_method = POST) {
                rewrite ^ /mcp break;
            }
            rewrite ^/minio/(.*) /$1 break;
            proxy_pass http://mcp_minio_backend_new;
        }
        
        # Handle /minio/messages requests (with session ID from SSE) - must come before /minio/ location
        location ~ ^/minio/messages {
            # Rewrite to /messages/ with trailing slash, query string preserved automatically
            rewrite ^/minio/messages(.*)$ /messages/$1 break;
            proxy_pass http://mcp_minio_backend_new;
            # Force HTTP/1.1 to avoid HTTP/2 mismatch (421 errors)
            proxy_http_version 1.1;
            # Set Host header to localhost to avoid host validation issues
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle /minio/message requests (with session ID from SSE) - same pattern as calculator
        # Note: FastMCP SSE uses /messages (plural) with session_id query param
        location ~ ^/minio/message(?:s)?/? {
            # Rewrite to /messages/ with trailing slash, preserving query string
            rewrite ^/minio/message(s)?(.*)$ /messages$2 break;
            proxy_pass http://mcp_minio_backend_new;
            # Force HTTP/1.1 to avoid HTTP/2 mismatch (421 errors)
            proxy_http_version 1.1;
            # Set Host header to localhost to avoid host validation issues
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle all other /minio/* paths
        location /minio/ {
            rewrite ^/minio/(.*) /$1 break;
            proxy_pass http://mcp_minio_backend_new;
            # Force HTTP/1.1 to avoid HTTP/2 mismatch (421 errors)
            proxy_http_version 1.1;
            # Set Host header to localhost to avoid host validation issues
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
            # Pass Minio connection headers for multi-tenant mode
            proxy_set_header X-Minio-Endpoint $http_x_minio_endpoint;
            proxy_set_header X-Minio-Access-Key $http_x_minio_access_key;
            proxy_set_header X-Minio-Secret-Key $http_x_minio_secret_key;
            proxy_set_header X-Minio-Secure $http_x_minio_secure;
            proxy_set_header X-Minio-Region $http_x_minio_region;
        }

        # Database MCP Server
        # Route: mcp.bionicaisolutions.com/database/sse
        location /database/ {
            rewrite ^/database/(.*) /$1 break;
            proxy_pass http://mcp_database_backend;
            # Pass database connection headers for multi-tenant mode
            proxy_set_header X-DB-Type $http_x_db_type;
            proxy_set_header X-DB-Host $http_x_db_host;
            proxy_set_header X-DB-Database $http_x_db_database;
            proxy_set_header X-DB-User $http_x_db_user;
            proxy_set_header X-DB-Password $http_x_db_password;
            proxy_set_header X-DB-Port $http_x_db_port;
            proxy_set_header X-DB-SSL $http_x_db_ssl;
            proxy_set_header X-DB-Path $http_x_db_path;
            proxy_set_header X-DB-Server $http_x_db_server;
            proxy_set_header X-DB-Connection-Timeout $http_x_db_connection_timeout;
            proxy_set_header X-DB-AWS-IAM-Auth $http_x_db_aws_iam_auth;
            proxy_set_header X-DB-AWS-Region $http_x_db_aws_region;
        }

        # PostgreSQL MCP Server
        # Route: mcp.bionicaisolutions.com/postgres/mcp
        location = /postgres/mcp {
            proxy_pass http://mcp_postgres_backend_new/mcp;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
            # Pass Postgres tenant headers for multi-tenant mode
            proxy_set_header X-Postgres-Tenant-Id $http_x_postgres_tenant_id;
        }

        # Route: mcp.bionicaisolutions.com/postgres/sse
        # Handle POST to /postgres/ (for Cursor discovery) - rewrite to /mcp
        location = /postgres/ {
            # Use mapped session ID (defaults to init-$request_id if not provided)
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header Accept "application/json, text/event-stream";
            
            if ($request_method = POST) {
                # For POST, rewrite to /mcp endpoint
                rewrite ^ /mcp break;
                proxy_pass http://mcp_postgres_backend_new;
                break;
            }
            # For GET, redirect to SSE endpoint
            return 301 /postgres/sse;
        }
        
        # Handle POST to /postgres/sse (Cursor tries this for streamableHttp) - rewrite to /mcp
        location = /postgres/sse {
            # Common proxy settings
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_buffering off;
            proxy_cache off;
            
            # For POST, rewrite to /mcp; for GET, rewrite to /sse
            if ($request_method = POST) {
                rewrite ^ /mcp break;
            }
            rewrite ^/postgres/(.*) /$1 break;
            proxy_pass http://mcp_postgres_backend_new;
        }
        
        # Handle /postgres/messages requests (with session ID from SSE)
        location ~ ^/postgres/messages {
            rewrite ^/postgres/messages(.*)$ /messages/$1 break;
            proxy_pass http://mcp_postgres_backend_new;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle /postgres/message requests (with session ID from SSE)
        location ~ ^/postgres/message(?:s)?/? {
            rewrite ^/postgres/message(s)?(.*)$ /messages$2 break;
            proxy_pass http://mcp_postgres_backend_new;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle all other /postgres/* paths
        location /postgres/ {
            rewrite ^/postgres/(.*) /$1 break;
            proxy_pass http://mcp_postgres_backend_new;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
        }

        # Health check endpoints (no auth required)
        # Note: Calculator doesn't have a /health endpoint, so we test /sse instead
        location /calculator/health {
            proxy_pass http://mcp_calculator_backend/sse;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Mcp-Session-Id health-check;
            proxy_read_timeout 2s;
        }

        location /minio/health {
            proxy_pass http://mcp_minio_backend_new/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /database/health {
            proxy_pass http://mcp_database_backend/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /postgres/health {
            proxy_pass http://mcp_postgres_backend_new/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # PDF Generator MCP Server
        # Route: mcp.bionicaisolutions.com/pdf-generator/mcp
        location = /pdf-generator/mcp {
            proxy_pass http://mcp_pdf_generator_backend/mcp;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
        }

        # Route: mcp.bionicaisolutions.com/pdf-generator/sse
        # Handle POST to /pdf-generator/ (for Cursor discovery) - rewrite to /mcp
        location = /pdf-generator/ {
            # Use mapped session ID (defaults to init-$request_id if not provided)
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8003;
            proxy_set_header Accept "application/json, text/event-stream";
            
            if ($request_method = POST) {
                # For POST, rewrite to /mcp endpoint
                rewrite ^ /mcp break;
                proxy_pass http://mcp_pdf_generator_backend;
                break;
            }
            # For GET, redirect to SSE endpoint
            return 301 /pdf-generator/sse;
        }
        
        # Handle POST to /pdf-generator/sse (Cursor tries this for streamableHttp) - rewrite to /mcp
        location = /pdf-generator/sse {
            # Common proxy settings
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8003;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_set_header Mcp-Session-Id $mcp_session_id;
            proxy_buffering off;
            proxy_cache off;
            
            # For POST, rewrite to /mcp; for GET, rewrite to /sse
            if ($request_method = POST) {
                rewrite ^ /mcp break;
            }
            rewrite ^/pdf-generator/(.*) /$1 break;
            proxy_pass http://mcp_pdf_generator_backend;
        }
        
        # Handle /pdf-generator/messages requests (with session ID from SSE)
        location ~ ^/pdf-generator/messages {
            rewrite ^/pdf-generator/messages(.*)$ /messages/$1 break;
            proxy_pass http://mcp_pdf_generator_backend;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8003;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle /pdf-generator/message requests (with session ID from SSE)
        location ~ ^/pdf-generator/message(?:s)?/? {
            rewrite ^/pdf-generator/message(s)?(.*)$ /messages$2 break;
            proxy_pass http://mcp_pdf_generator_backend;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8003;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
        
        # Handle all other /pdf-generator/* paths
        location /pdf-generator/ {
            rewrite ^/pdf-generator/(.*) /$1 break;
            proxy_pass http://mcp_pdf_generator_backend;
            proxy_http_version 1.1;
            proxy_set_header Host 127.0.0.1:8003;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept "application/json, text/event-stream";
            proxy_buffering off;
            proxy_cache off;
        }

        # Health check endpoint
        location /pdf-generator/health {
            proxy_pass http://mcp_pdf_generator_backend/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Default - show available paths
        location / {
            return 404 "MCP server not found. Available paths: /calculator/, /minio/, /database/, /postgres/, /pdf-generator/";
        }
    }

    # HTTPS server for archon.baisoln.com
    server {
        listen 443 ssl;
        http2 on;
        server_name archon.baisoln.com;

        ssl_certificate /etc/letsencrypt/live/archon.baisoln.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/archon.baisoln.com/privkey.pem;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Increase timeouts for long-running MCP requests
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        
        # Buffer settings for SSE
        proxy_buffering off;
        proxy_cache off;

        # Archon UI - serve at root
        location / {
            proxy_pass http://archon_ui_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Cache control for static assets
            proxy_cache_bypass $http_upgrade;
        }

        # Archon MCP endpoints
        location /mcp {
            proxy_pass http://archon_backend/mcp;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection '';
            proxy_set_header Cache-Control 'no-cache';
            proxy_set_header Accept 'application/json, text/event-stream';
            proxy_buffering off;
            chunked_transfer_encoding off;
        }

        # Health endpoint - no auth required
        location /health {
            proxy_pass http://archon_backend/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}

